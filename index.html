<!DOCTYPE html>
<html lang="en">


<!-- 
===========================================================
Thank you for reading this source! :))
Want to improve this code??
Feel free to contact me: ovis1gmelini@gmail.com

お疲れ様です！
ソースをご確認いただきありがとうございます！(/ω＼*)
問題がある部分やご意見等ございましたら、ご連絡いただければ幸いです。
連絡先: ovis1gmelini@gmail.com
===========================================================
-->

<head>
  <title>Heritage Map Project</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel = "stylesheet" href = "src/styles.css" />
  <link rel = "stylesheet" href = "src/filcon_styles.css" />
  <link rel = "stylesheet" href = "src/regcon_styles.css" />
  <link rel = "stylesheet" href = "src/image_styles.css" />
</head>
<body>
  


<!-- Main Screen-->
<div id="map"></div>


<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Leaflet Hash plugin -->
<script src="https://unpkg.com/leaflet-hash"></script>

<!-- Data for sites -->
<script src="src/data.js"></script>
<script src="src/solid_data.js"></script>

<!-- Functions for sites -->
<script src="src/function.js"></script>


<script type="module">
  
  /*
  #######################
  #######################
  ####   Main code   ####
  #######################
  #######################
  */
  
  /*
  #####################################
  ######   Map initialization   #######
  #####################################
  
      continuousWorld: false
      worldCopyJump: true
      zoomControl: custom -> later
      maxZoom: 18
      minZoom: 6
  
      attribution:  
        https://bcforestdiscoverycentre.com/
        https://leafletjs.com
        +
        map attribution: details in function (layerControl)
          
  
  */
    //map
    const map = L.map('map',{zoomControl:false, maxZoom:18, minZoom:5}).setView([51.5, -127], 7);
  
    //attribution
      map.attributionControl.setPrefix('<a href="https://bcforestdiscoverycentre.com/" target="_blank" class = ".leaflet-control-attribution">BCFDC</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps"  class = ".leaflet-control-attribution">Leaflet</a>');
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
    

    //Show the hash tag for the screen location on the url. Leaflet extension
      var hash = new L.Hash(map);

    //Set the restriction to move the screen. 
     var fixedBounds = L.latLngBounds(
        [47.80, -140.56], // Southwest corner (southmost + westmost combined)
        [60.50, -113.55]  // Northeast corner (northmost + eastmost combined)
      );

      function setBounds() {
           map.setMaxBounds(fixedBounds);
      }
      setBounds();
 
      //I don't know the following.
      //     var bounds_group = new L.featureGroup([]);
      
      
  
  
  /*
  #########################
  ######   Markers   ######
  #########################


      Debug by checking if data.js is updated and if it operates this part of program. 
      Check each point has error or not
        >> Yes: Show it on map
        >> No: Do nothing 
      Add every points on the map using createPopupContent()
      Group them to assign icon and filter
      Store all info in markers, which stores: 
        marker,
        category (point.category), 
        yearStart.
        yearEnd,
        name (point.title + point.company),
        area
      

  */
      //An array to store them (exclusively good points)
      let markers = []
 

    let count_area = {};//Disctionary donesn't need if statement

    try{

      points.forEach(point => {
        if(!point.error){//This is Publish
          const marker = L.marker(point.coords);
          if(point.category == 'sawmill'){
            marker.setIcon(sawmill_icon);
          }
          else if(point.category == 'camp'){
            marker.setIcon(camp_icon);
          }
          else if(point.category == 'paper'){
            marker.setIcon(paper_icon);
          }
          else if(point.category == 'community'){
            marker.setIcon(community_icon);
          }

          
          marker.bindPopup(() => {
            const popupContent = createPopupContent(point);
            return popupContent;
          }, {
              maxWidth: 500,
              minWidth: 300 // optional, for fixed width
          }) 
          marker.addTo(map);
          if(!point.error){
            if (!count_area.hasOwnProperty(point.area)) {
              count_area[point.area] = 1;
            } else{
              count_area[point.area]  = count_area[point.area] + 1;
            }
            markers.push({
              marker: marker,
              category: point.category,
              yearStart: +point.year.slice(0,4),
              yearEnd: +point.year.slice(5,9),
              name: point.title + '(' + point.company + ')',
              area: point.area,
            });
          }
        }

        
       });
      if (points.length == 0){
        alert("Seems you have not updated the data.js file \n Read instructions here (https://github.com/Mufurun/interactiveMap)");
      }

    }catch(error){console.log(error);
      alert("Seems to have at least an error. \nPlease check data entry. and try again");}



/*
  ##########################################
  ######     All Kinds of Controls     #####
  ##########################################
       Zoom control:
       Region Control:
       Current Position:
       Layer Control:
  */
  
  /*
  ******************************
  ******   zoomControl    ******
  ******************************
      See styles.css
  */
  
      var zoomControl = L.control.zoom({
              position: 'bottomright'
          }).addTo(map);
  
       
  

  /*
  ***********************************
  ******   Regional Control    ******
  ***********************************
  
      Hover to open.
      Click the button to zoom up the region.
      Click the bar to open the lower categories/close those siblings.
      Click to zoom up the region.
      Click to see how to use.

      customControlhtml(count_area);
          Show regions due to the area of the data.js. 
      listMarkers(map, markers, region) to set up the html styles 
          Add list buttons to fly to and open the popup.

      
  */
       const customControl = L.Control.extend({
        onAdd: function (map) {
          const container = L.DomUtil.create('div', 'custom-control leaflet-bar');
          container.innerHTML = customControlhtml(count_area);
  
          // Prevent map click propagation
          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableScrollPropagation(container);
  
          // Delay attaching the event until the DOM is ready.
          setTimeout(() => {
            //Click the list to fly to and open the popup.
            regions.forEach(region =>{
              const btn = document.getElementById(region.id);
              if(btn){
                btn.addEventListener("click", () => {
                  map.flyTo(region.zoom,region.size);
                });
              }
            })
            
            //Click the bar to open the lower categories/close those siblings, and Add Zoomup Button
            const collapsibles = document.querySelectorAll(".collapsible");
            collapsibles.forEach(button => {
              button.addEventListener("click", function () {
                const content = this.parentElement.nextElementSibling;
                if (content.style.maxHeight) {
                  content.style.maxHeight = null;
                  this.classList.toggle("active");
                  updateChildren(content);  
                } else {
                  this.classList.toggle("active");
                  content.style.maxHeight = 350 + "px";
                  updateSibling(content);  
                  updateParentHeight(content);
                }
              });
            });

            //Original Map Zoomup
            const world = document.querySelectorAll(".button-original-map");
            world.forEach(button => {
              button.addEventListener("click", function () {
                const content = this.nextElementSibling;
                updateSibling(content);  
                  
              });
            });
            const regconbutton = document.getElementById('regcon');
            if(regconbutton){
                regconbutton.addEventListener("click", () => {
                  alert(`Click to Open the Specific Region. 
Click Plus Sign to Zoom In`);
                });
            }

  
            region_categories.forEach(location =>{
                listMarkers(map, markers, location);
            });
          }, 0);
  
          return container;
        }
      });
  
  
      

  /*
  *********************************
  ******   Filter Control    ******
  *********************************  

      Hover to open.
      Select the categories.
      Pick the year/type the year.
      Click to see how to use.


      filterControlhtml()
        Style the innerHTML

      filterMarker(map, markers, allTime = false, allSite = false) 
        Add/Remove each marker on the map as the filters selected.



  */
      const filterControl = L.Control.extend({
        onAdd: function (map) {
          const container = L.DomUtil.create('div', 'filter-control leaflet-bar');
          container.innerHTML = filterControlhtml();

          // Prevent map click propagation
          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableScrollPropagation(container);

          setTimeout(() => {
            //Change the categories: camp, sawmill, p&p, community, BCFS
            category_list.forEach(obj =>{
              document.getElementById(obj).addEventListener('change', function(){
                let bool = false;
                if (document.getElementById('showFilterYear').value == 'All Time'){
                  bool = true;
                }
                filterMarker(map, markers, bool);
              });
            });

            //Change the year.
            document.getElementById('filterYear').addEventListener('input',function(){
              filterMarker(map, markers);
              document.getElementById('showFilterYear').value = this.value;
            });
            document.getElementById('allTime').addEventListener('click',function(){
              filterMarker(map, markers, true);
              document.getElementById('showFilterYear').value = 'All Time';
              document.getElementById('filterYear').value = 2025;
            });
            document.getElementById('showFilterYear').addEventListener("input", function () {
              this.value = this.value.replace(/\D/g, "");
              document.getElementById('filterYear').value = this.value;
              if(1848 <= +this.value && +this.value <= 2025){
                filterMarker(map, markers);
              }
              if(this.value == ""){
                document.getElementById('filterYear').value = 0;
              }
            });

            const filconbutton = document.getElementById('filcon');
            if(filconbutton){
                filconbutton.addEventListener("click", () => {
                  alert(`Select Categories of sites.
Change the bar or Type the year to select year.
Or Click All Time button.`);
                });
            }


          }, 0);
    
          return container;
        }
      });


  /*
  ********************************
  ******   Layer Control    ******
  ********************************

      Select the Layer
      Change the tile of the map


      layerControlhtml()
        Style the inner HTML

      layerFunctions(map)
        Change the tile as the layer selected.

  */
      const layerControl = L.Control.extend({
        onAdd: function (map) {
          const container = L.DomUtil.create('div');
          container.innerHTML = layerControlhtml();
          layerFunctions(map);

  
          // Prevent map click propagation
          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableScrollPropagation(container);

          setTimeout(()=>{
            const layconbutton = document.getElementById('laycon');
            if(layconbutton){
                layconbutton.addEventListener("click", () => {
                  alert("Change the Map Layer");
                });
            }
          },0)

    
          return container;
        }
      });


/*
##########################################
###########    ADD CONTROLs    ###########
##########################################

      Do not add it bottom. Bottom will be covered by the map attribution for narrow screen. 
*/
      map.addControl(new layerControl({ position: 'topleft' }));
      map.addControl(new filterControl({ position: 'topright' }));
      map.addControl(new customControl({ position: 'topleft' }));



  /*
*********************************************
******   Specific Style for Phone User ******
*********************************************

      When click the popup. open the popup with full content shown; in the other word, the content is insize the screen view and not covered by the controls. 
*/
        size_for_phone(map);  
  </script>

</body>
</html>
